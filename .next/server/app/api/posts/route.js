"use strict";(()=>{var e={};e.id=990,e.ids=[990],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8213:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>l});var n=r(9303),o=r(8716),a=r(670),i=r(7070),u=r(5655),d=r(8656);async function c(e){try{let t=await (0,u.f)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:n}=new URL(e.url),o=n.get("brandId"),a=n.get("status"),d=Math.min(parseInt(n.get("limit")||"50"),100),c=parseInt(n.get("offset")||"0");if(!o)return i.NextResponse.json({error:"brandId is required"},{status:400});let{data:l,error:p}=await t.from("brands").select("id").eq("id",o).eq("user_id",r.id).single();if(p||!l)return i.NextResponse.json({error:"Brand not found"},{status:404});let f=t.from("posts").select("*",{count:"exact"}).eq("brand_id",o).order("scheduled_for",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1});a&&["draft","scheduled","published","failed"].includes(a)&&(f=f.eq("status",a)),f=f.range(c,c+d-1);let{data:h,error:m,count:_}=await f;if(m)return i.NextResponse.json({error:"Failed to fetch posts"},{status:500});return i.NextResponse.json({data:h||[],count:_||0,limit:d,offset:c,status:200})}catch(e){return console.error("GET /api/posts error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e){try{let t=await (0,u.f)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{brandId:n,content:o,mediaUrls:a=[],platforms:c=[],status:l="draft",scheduledFor:p,location:f}=await e.json();if(!n)return i.NextResponse.json({error:"brandId is required"},{status:400});if(!o||0===Object.keys(o).length)return i.NextResponse.json({error:"content is required"},{status:400});if(!Array.isArray(c)||0===c.length)return i.NextResponse.json({error:"platforms array is required and must not be empty"},{status:400});if("scheduled"===l&&!p)return i.NextResponse.json({error:"scheduledFor is required when status is 'scheduled'"},{status:400});let{data:h,error:m}=await t.from("brands").select("id, late_profile_id").eq("id",n).eq("user_id",r.id).single();if(m||!h)return i.NextResponse.json({error:"Brand not found"},{status:404});if(p){let e=new Date(p),t=new Date,r=new Date;if(r.setMonth(r.getMonth()+2),e<t)return i.NextResponse.json({error:"scheduledFor must be in the future"},{status:400});if(e>r)return i.NextResponse.json({error:"scheduledFor must be within 2 months"},{status:400})}let{data:_,error:x}=await t.from("posts").insert({brand_id:n,user_id:r.id,content:o,media_urls:a,platforms:c,status:l,scheduled_for:"scheduled"===l?p:null,location:f||null}).select().single();if(x)return console.error("Database insert error:",x),i.NextResponse.json({error:"Failed to create post"},{status:500});let y=null;if("published"===l&&h.late_profile_id)try{let e=o[c[0]]||o[Object.keys(o)[0]]||"";y=(await (0,d.qb)({profileId:h.late_profile_id,text:e,mediaUrls:a,platforms:c,publishNow:!0})).id,await t.from("posts").update({late_post_id:y}).eq("id",_.id)}catch(e){console.error("Failed to create post on getlate.dev:",e)}return i.NextResponse.json({data:{..._,late_post_id:y},status:201},{status:201})}catch(e){return console.error("POST /api/posts error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/posts/route",pathname:"/api/posts",filename:"route",bundlePath:"app/api/posts/route"},resolvedPagePath:"/Users/tezferguson/gitProjects/onitsocial/src/app/api/posts/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:m}=p,_="/api/posts/route";function x(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},8656:(e,t,r)=>{r.d(t,{AM:()=>d,ED:()=>i,HH:()=>_,_U:()=>m,bP:()=>c,fR:()=>f,he:()=>u,mb:()=>h,qb:()=>p,tm:()=>l});let s=process.env.LATE_API_BASE_URL||"https://getlate.dev/api/v1",n=process.env.LATE_API_KEY||"";class o extends Error{constructor(e,t,r){super(t),this.statusCode=e,this.responseBody=r,this.name="LateApiError"}}async function a(e,t={}){let{method:r="GET",body:a,params:i}=t,u=`${s}${e}`;if(i){let e=new URLSearchParams(i);u+=`?${e.toString()}`}let d={Authorization:`Bearer ${n}`,"Content-Type":"application/json"},c=await fetch(u,{method:r,headers:d,body:a?JSON.stringify(a):void 0});if(!c.ok){let e=await c.json().catch(()=>null);throw new o(c.status,`Late API error: ${c.status} ${c.statusText}`,e)}if(204!==c.status)return c.json()}async function i(e){let t=await a("/profiles",{method:"POST",body:{name:e}});return{id:t.profile._id,name:t.profile.name}}async function u(e){return a(`/profiles/${e}`,{method:"DELETE"})}async function d(e,t,r){let s=await a(`/connect/${e}`,{params:{profileId:t,redirect_url:r,headless:"true"}}),n=s.url||s.connectUrl||s.authUrl;if(!n)throw console.error("Unexpected getLate connect response:",s),Error("No connect URL in response");return{url:n}}async function c(e){let t=await a("/accounts",{params:{profileId:e}});return t.accounts?{data:t.accounts.map(e=>({id:e._id||e.id,platform:e.platform,username:e.username||e.name||"",avatarUrl:e.avatarUrl||""}))}:{data:t.data||[]}}async function l(e){return a(`/accounts/${e}`,{method:"DELETE"})}async function p(e){return a("/posts",{method:"POST",body:e})}async function f(e){return a(`/posts/${e}`,{method:"DELETE"})}async function h(e,t,r){return a(`/analytics/${e}`,{params:{startDate:t,endDate:r}})}async function m(e,t){let r={profileId:e};return t&&(r.cursor=t),a("/messages",{params:r})}async function _(e,t){return a(`/messages/${e}/reply`,{method:"POST",body:{text:t}})}},5655:(e,t,r)=>{r.d(t,{f:()=>o,k:()=>a});var s=r(7721),n=r(1615);async function o(){let e=await (0,n.cookies)();return(0,s.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch{}},remove(t,r){try{e.set({name:t,value:"",...r})}catch{}}}})}async function a(){let{createClient:e}=await Promise.resolve().then(r.bind(r,7857));return e(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,9702,5972],()=>r(8213));module.exports=s})();