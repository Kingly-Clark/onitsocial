"use strict";(()=>{var e={};e.id=4737,e.ids=[4737],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4062:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{GET:()=>l});var a=r(9303),s=r(8716),o=r(670),c=r(7070),i=r(5655),u=r(8656);async function l(e){try{let t=await (0,i.f)(),{data:{user:r},error:n}=await t.auth.getUser();if(n||!r)return c.NextResponse.redirect(new URL("/login",e.url));let a=e.nextUrl.searchParams,s=a.get("code"),o=a.get("profileId"),l=a.get("platform");if(!s||!o||!l)return c.NextResponse.json({error:"Missing required parameters"},{status:400});let{data:d,error:p}=await t.from("brands").select("id, late_profile_id").eq("late_profile_id",o).eq("user_id",r.id).single();if(p||!d)return c.NextResponse.json({error:"Brand not found"},{status:404});let f=[];try{f=(await (0,u.bP)(o)).data||[]}catch(e){console.error("Failed to list accounts from Late API:",e)}let m=f.find(e=>e.platform.toLowerCase()===l.toLowerCase());if(!m)return c.NextResponse.json({error:"Account connection failed"},{status:400});let{data:_}=await t.from("connected_accounts").select("id").eq("brand_id",d.id).eq("platform",l).single();if(_){let{error:e}=await t.from("connected_accounts").update({late_account_id:m.id,platform_username:m.username||null,platform_avatar:m.avatarUrl||null,status:"active"}).eq("id",_.id);if(e)return console.error("Failed to update account:",e),c.NextResponse.json({error:"Failed to update account"},{status:500})}else{let{error:e}=await t.from("connected_accounts").insert({brand_id:d.id,platform:l,late_account_id:m.id,platform_username:m.username||null,platform_avatar:m.avatarUrl||null,status:"active"});if(e)return console.error("Failed to insert account:",e),c.NextResponse.json({error:"Failed to save account"},{status:500})}let h=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";return c.NextResponse.redirect(new URL(`/brands/${d.id}/settings?connected=true`,h))}catch(e){return console.error("GET /api/connections/callback error:",e),c.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/connections/callback/route",pathname:"/api/connections/callback",filename:"route",bundlePath:"app/api/connections/callback/route"},resolvedPagePath:"/Users/tezferguson/gitProjects/onitsocial/src/app/api/connections/callback/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:m}=d,_="/api/connections/callback/route";function h(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}},8656:(e,t,r)=>{r.d(t,{AM:()=>u,ED:()=>c,HH:()=>h,_U:()=>_,bP:()=>l,fR:()=>f,he:()=>i,mb:()=>m,qb:()=>p,tm:()=>d});let n=process.env.LATE_API_BASE_URL||"https://api.getlate.dev/v1",a=process.env.LATE_API_KEY||"";class s extends Error{constructor(e,t,r){super(t),this.statusCode=e,this.responseBody=r,this.name="LateApiError"}}async function o(e,t={}){let{method:r="GET",body:o,params:c}=t,i=`${n}${e}`;if(c){let e=new URLSearchParams(c);i+=`?${e.toString()}`}let u={Authorization:`Bearer ${a}`,"Content-Type":"application/json"},l=await fetch(i,{method:r,headers:u,body:o?JSON.stringify(o):void 0});if(!l.ok){let e=await l.json().catch(()=>null);throw new s(l.status,`Late API error: ${l.status} ${l.statusText}`,e)}if(204!==l.status)return l.json()}async function c(e){return o("/profiles",{method:"POST",body:{name:e}})}async function i(e){return o(`/profiles/${e}`,{method:"DELETE"})}async function u(e,t,r){return o(`/connect/${e}`,{params:{profileId:t,callbackUrl:r}})}async function l(e){return o("/accounts",{params:{profileId:e}})}async function d(e){return o(`/accounts/${e}`,{method:"DELETE"})}async function p(e){return o("/posts",{method:"POST",body:e})}async function f(e){return o(`/posts/${e}`,{method:"DELETE"})}async function m(e,t,r){return o(`/analytics/${e}`,{params:{startDate:t,endDate:r}})}async function _(e,t){let r={profileId:e};return t&&(r.cursor=t),o("/messages",{params:r})}async function h(e,t){return o(`/messages/${e}/reply`,{method:"POST",body:{text:t}})}},5655:(e,t,r)=>{r.d(t,{f:()=>s,k:()=>o});var n=r(7721),a=r(1615);async function s(){let e=await (0,a.cookies)();return(0,n.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,n){try{e.set({name:t,value:r,...n})}catch{}},remove(t,r){try{e.set({name:t,value:"",...r})}catch{}}}})}async function o(){let{createClient:e}=await Promise.resolve().then(r.bind(r,7857));return e(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,9702,5972],()=>r(4062));module.exports=n})();