"use strict";(()=>{var e={};e.id=3749,e.ids=[3749],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98357:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>E,routeModule:()=>_,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{POST:()=>l});var o=r(49303),a=r(88716),i=r(60670),n=r(87070),c=r(46029),u=r(65655);async function p(){let e={solo:process.env.STRIPE_PRICE_SOLO||"",starter:process.env.STRIPE_PRICE_STARTER||"",advanced:process.env.STRIPE_PRICE_ADVANCED||""};return{[e.solo]:"solo",[e.starter]:"starter",[e.advanced]:"advanced"}}async function d(e){return(await p())[e]||null}async function l(e){try{let t;let r=await e.text(),s=e.headers.get("stripe-signature");if(!s||!process.env.STRIPE_WEBHOOK_SECRET)return n.NextResponse.json({error:"Missing signature or webhook secret"},{status:400});try{t=(0,c.d)().webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e),n.NextResponse.json({error:"Invalid signature"},{status:400})}let o=await (0,u.k)();switch(t.type){case"checkout.session.completed":{let e=t.data.object,r=e.metadata?.user_id,s=e.metadata?.plan;if(!r||!s){console.warn("checkout.session.completed missing metadata");break}let a=await (0,c.d)().subscriptions.retrieve(e.subscription),i=a.items.data[0]?.price.id,n=await d(i)||s,u=["solo","starter","advanced"].includes(n)?({solo:1,starter:5,advanced:10})[n]:1;await o.from("users").update({subscription_plan:n,subscription_status:"active",brand_limit:u}).eq("id",r);break}case"customer.subscription.updated":{let e=t.data.object,r=e.customer,{data:s,error:a}=await o.from("users").select("id").eq("stripe_customer_id",r).single();if(a||!s){console.warn("User not found for stripe customer:",r);break}let i=e.items.data[0]?.price.id,n=await d(i);if(!n){console.warn("Plan not found for price ID:",i);break}let c="active";"past_due"===e.status?c="past_due":"trialing"===e.status&&(c="trialing"),await o.from("users").update({subscription_plan:n,subscription_status:c,brand_limit:{solo:1,starter:5,advanced:10}[n]}).eq("id",s.id);break}case"customer.subscription.deleted":{let e=t.data.object.customer,{data:r,error:s}=await o.from("users").select("id").eq("stripe_customer_id",e).single();if(s||!r){console.warn("User not found for stripe customer:",e);break}await o.from("users").update({subscription_status:"canceled",subscription_plan:"solo",brand_limit:1}).eq("id",r.id);break}case"invoice.payment_failed":{let e=t.data.object,r=e.customer;e.subscription;let{data:s,error:a}=await o.from("users").select("id").eq("stripe_customer_id",r).single();if(a||!s){console.warn("User not found for stripe customer:",r);break}await o.from("users").update({subscription_status:"past_due"}).eq("id",s.id);break}default:console.log("Unhandled event type:",t.type)}return n.NextResponse.json({received:!0},{status:200})}catch(e){return console.error("Webhook error:",e),n.NextResponse.json({received:!0},{status:200})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/billing/webhook/route",pathname:"/api/billing/webhook",filename:"route",bundlePath:"app/api/billing/webhook/route"},resolvedPagePath:"/Users/tezferguson/gitProjects/onitsocial/src/app/api/billing/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:E,staticGenerationAsyncStorage:v,serverHooks:b}=_,m="/api/billing/webhook/route";function f(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},46029:(e,t,r)=>{r.d(t,{d:()=>a,r:()=>i});var s=r(89777);let o=null;function a(){if(!o){if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");o=new s.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2026-01-28.clover",typescript:!0})}return o}let i={solo:process.env.STRIPE_PRICE_SOLO||"",starter:process.env.STRIPE_PRICE_STARTER||"",advanced:process.env.STRIPE_PRICE_ADVANCED||""}},65655:(e,t,r)=>{r.d(t,{f:()=>a,k:()=>i});var s=r(67721),o=r(71615);async function a(){let e=await (0,o.cookies)();return(0,s.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch{}},remove(t,r){try{e.set({name:t,value:"",...r})}catch{}}}})}async function i(){let{createClient:e}=await Promise.resolve().then(r.bind(r,37857));return e(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,9702,5972,9777],()=>r(98357));module.exports=s})();