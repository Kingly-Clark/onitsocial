"use strict";(()=>{var e={};e.id=5270,e.ids=[5270],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9217:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>d});var n=r(9303),a=r(8716),o=r(670),i=r(7070),c=r(5655),u=r(8656);async function d(e){try{let t=await (0,c.f)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{brand_id:n}=await e.json();if(!n)return i.NextResponse.json({error:"brand_id is required"},{status:400});let{data:a,error:o}=await t.from("brands").select("id, late_profile_id").eq("id",n).eq("user_id",r.id).single();if(o||!a)return i.NextResponse.json({error:"Brand not found or unauthorized"},{status:404});if(!a.late_profile_id)return i.NextResponse.json({data:[],count:0,status:200});let{data:d,error:l}=await t.from("connected_accounts").select("id, late_account_id, platform").eq("brand_id",n).eq("status","active");if(l)return i.NextResponse.json({error:"Failed to fetch connected accounts"},{status:500});if(!d||0===d.length)return i.NextResponse.json({data:[],count:0,status:200});let p=0,f=[],_=new Set,{data:m}=await t.from("inbox_messages").select("late_message_id").eq("brand_id",n);for(let e of(m&&m.forEach(e=>{_.add(e.late_message_id)}),d))try{let t=await u._U(a.late_profile_id);if(t?.data&&Array.isArray(t.data))for(let r of t.data)!_.has(r.id)&&r.accountId===e.late_account_id&&(f.push({brand_id:n,connected_account_id:e.id,type:r.type,platform:e.platform,sender_name:r.senderName,sender_avatar:r.senderAvatar||null,content:r.content,is_read:!1,is_resolved:!1,late_message_id:r.id,thread_id:r.threadId||null,received_at:new Date(r.createdAt).toISOString(),replied_at:null}),p++)}catch(t){console.error(`Failed to fetch messages for account ${e.late_account_id}:`,t)}if(f.length>0){let{error:e}=await t.from("inbox_messages").insert(f);if(e)return console.error("Failed to insert messages:",e),i.NextResponse.json({error:"Failed to sync messages"},{status:500})}return i.NextResponse.json({data:f,count:p,status:200})}catch(e){return console.error("POST /api/inbox/sync error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/inbox/sync/route",pathname:"/api/inbox/sync",filename:"route",bundlePath:"app/api/inbox/sync/route"},resolvedPagePath:"/Users/tezferguson/gitProjects/onitsocial/src/app/api/inbox/sync/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:_}=l,m="/api/inbox/sync/route";function h(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},8656:(e,t,r)=>{r.d(t,{AM:()=>u,ED:()=>i,HH:()=>h,_U:()=>m,bP:()=>d,fR:()=>f,he:()=>c,mb:()=>_,qb:()=>p,tm:()=>l});let s=process.env.LATE_API_BASE_URL||"https://api.getlate.dev/v1",n=process.env.LATE_API_KEY||"";class a extends Error{constructor(e,t,r){super(t),this.statusCode=e,this.responseBody=r,this.name="LateApiError"}}async function o(e,t={}){let{method:r="GET",body:o,params:i}=t,c=`${s}${e}`;if(i){let e=new URLSearchParams(i);c+=`?${e.toString()}`}let u={Authorization:`Bearer ${n}`,"Content-Type":"application/json"},d=await fetch(c,{method:r,headers:u,body:o?JSON.stringify(o):void 0});if(!d.ok){let e=await d.json().catch(()=>null);throw new a(d.status,`Late API error: ${d.status} ${d.statusText}`,e)}if(204!==d.status)return d.json()}async function i(e){return o("/profiles",{method:"POST",body:{name:e}})}async function c(e){return o(`/profiles/${e}`,{method:"DELETE"})}async function u(e,t,r){return o(`/connect/${e}`,{params:{profileId:t,callbackUrl:r}})}async function d(e){return o("/accounts",{params:{profileId:e}})}async function l(e){return o(`/accounts/${e}`,{method:"DELETE"})}async function p(e){return o("/posts",{method:"POST",body:e})}async function f(e){return o(`/posts/${e}`,{method:"DELETE"})}async function _(e,t,r){return o(`/analytics/${e}`,{params:{startDate:t,endDate:r}})}async function m(e,t){let r={profileId:e};return t&&(r.cursor=t),o("/messages",{params:r})}async function h(e,t){return o(`/messages/${e}/reply`,{method:"POST",body:{text:t}})}},5655:(e,t,r)=>{r.d(t,{f:()=>a,k:()=>o});var s=r(7721),n=r(1615);async function a(){let e=await (0,n.cookies)();return(0,s.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch{}},remove(t,r){try{e.set({name:t,value:"",...r})}catch{}}}})}async function o(){let{createClient:e}=await Promise.resolve().then(r.bind(r,7857));return e(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,9702,5972],()=>r(9217));module.exports=s})();